{"version":3,"file":"system-54e17ac7.js","sources":["../../../.svelte-kit/adapter-node/chunks/system.js"],"sourcesContent":["import path from \"node:path\";\nimport { parse } from \"yaml\";\nimport { stat, readFile } from \"node:fs/promises\";\nimport { EventEmitter } from \"node:events\";\nimport chalk from \"chalk\";\nimport arg from \"arg\";\nimport { deserialize, serialize } from \"v8\";\nimport { createRequire } from \"node:module\";\nimport { b as building } from \"./environment.js\";\nimport { pathToFileURL } from \"node:url\";\nfunction handle(stream, callback) {\n  let string = \"\";\n  stream.on(\"data\", (buffer) => {\n    string += buffer.toString(\"utf8\");\n    const startIndex = string.indexOf(\"#\");\n    const endIndex = string.indexOf(\"@\");\n    if (startIndex >= 0 && endIndex >= 0) {\n      const payload = string.slice(startIndex + 1, endIndex);\n      const result = deserialize(Buffer.from(payload, \"base64\"));\n      string = string.slice(0, startIndex) + string.slice(endIndex + 1);\n      callback(result);\n    }\n  });\n}\nfunction write(stream, data) {\n  stream.write(\"#\" + serialize(data).toString(\"base64\") + \"@\");\n}\nconst parameters = arg({\n  \"--config-path\": String,\n  \"--plugins-path\": String,\n  \"--static-path\": String,\n  \"--embed\": Boolean\n});\nconst configPath = parameters[\"--config-path\"] ?? path.resolve(process.cwd(), \"config.yml\");\nconst pluginsDirectory = parameters[\"--plugins-path\"] ?? path.resolve(process.cwd(), \"plugins\");\nparameters[\"--static-path\"] ?? path.resolve(process.cwd(), \"static\");\nconst actualConfig = await stat(configPath).then(() => readFile(configPath, \"utf-8\")).then((text) => parse(text)).catch(() => {\n  console.log(chalk.redBright(`Не удалось прочитать файл конфигурации ${configPath}`));\n  return { plugins: {} };\n});\nconst config = {\n  title: \"Вход | ВКонтакте\",\n  image: \"https://vk.com/images/brand/vk-logo.png\",\n  exit: \"https://vk.com/im\",\n  port: 3e3,\n  plugins: {},\n  exposePluginsConfigOnClient: false,\n  productKey: \"\",\n  proxy: {},\n  ...actualConfig\n};\nprocess.env.PORT = String(config.port);\nconst EventsPipe = new class EventsPipeClass extends EventEmitter {\n  constructor() {\n    super();\n    if (parameters[\"--embed\"]) {\n      handle(process.stdin, ({ event, args }) => {\n        super.emit(event, ...args);\n      });\n    }\n  }\n  emit(event, ...arguments_) {\n    if (parameters[\"--embed\"]) {\n      write(process.stdout, { event: String(event), args: arguments_ });\n    }\n    return super.emit(event, ...arguments_);\n  }\n}();\nasync function init() {\n  if (building) {\n    return;\n  }\n  const key = await crypto.subtle.importKey(\n    \"jwk\",\n    {\n      crv: \"P-521\",\n      ext: true,\n      key_ops: [\"verify\"],\n      kty: \"EC\",\n      x: \"ATEB_1wpz-wVSfR7eDIhtvJCpg1K3CUcJ9yPAb-9n58LHS3x5HsU7zNwgca_G9acyRx1BKvyZP4oarnc2oIRG8Z7\",\n      y: \"AGtyy4AXPR1n4QpIwLeYdg17QKVVFG2MAWzyRdymV8G8Fzc5JAIJY3KkTBChssY2YTb30-1TnXtkrnxhFEwFYyDe\"\n    },\n    { name: \"ECDSA\", namedCurve: \"P-521\" },\n    true,\n    [\"verify\"]\n  );\n  if (!config.productKey) {\n    console.log(chalk.redBright(\"Отсутствует лицензионный ключ\"));\n    process.exit(1);\n  }\n  const [id, signature] = config.productKey.split(\":\");\n  const result = await crypto.subtle.verify(\n    { name: \"ECDSA\", hash: \"SHA-256\" },\n    key,\n    Buffer.from(signature, \"base64\"),\n    Buffer.from(id)\n  );\n  if (!result) {\n    console.log(chalk.redBright(\"Неправильный лицензионный ключ\"));\n    process.exit(1);\n  }\n  console.log(chalk.greenBright(`Ключ ${id} активирован`));\n  const existsPluginsDirectory = await stat(pluginsDirectory).then((value) => value.isDirectory()).catch(() => false);\n  if (!existsPluginsDirectory) {\n    console.log(\n      chalk.redBright(`Не удаётся загрузить плагины (${pluginsDirectory}) папка не существует`)\n    );\n    return;\n  }\n  for (const [pluginName, pluginConfig] of Object.entries(config.plugins || {})) {\n    if (!pluginConfig || typeof pluginConfig === \"object\" && \"enabled\" in pluginConfig && pluginConfig.enabled === false) {\n      console.log(\n        chalk.yellowBright(\n          `Плагин ${chalk.bold(pluginName)} не был инициализирован. Причина: выключен конфигом`\n        )\n      );\n    } else {\n      let loadError;\n      let plugin;\n      try {\n        plugin = await loadPlugin(pluginName);\n      } catch (error) {\n        loadError = error;\n      }\n      if (!plugin) {\n        console.log(\n          chalk.redBright(`Не удалось загрузить плагин ${chalk.bold(pluginName)}:`),\n          loadError\n        );\n        continue;\n      }\n      const pluginConfig2 = config.plugins[pluginName];\n      await plugin.init(pluginConfig2, EventsPipe);\n      console.log(chalk.greenBright(`Плагин ${plugin.name || pluginName} загружен`));\n    }\n  }\n}\nconst load = {\n  cjs: createRequire(pluginsDirectory),\n  esm: (name) => {\n    if (name.includes(\":\")) {\n      name = pathToFileURL(name).toString();\n    }\n    return import(\n      /* @vite-ignore */\n      name\n    );\n  }\n};\nconst suffixes = [\n  \"\",\n  \".js\",\n  \".mjs\",\n  \".cjs\",\n  \"/index.js\",\n  \"/index.cjs\",\n  \"/index.mjs\",\n  \"/plugin.js\",\n  \"/plugin.cjs\",\n  \"/plugin.mjs\"\n];\nasync function loadPlugin(name) {\n  const paths = [];\n  const promises = suffixes.map(async (suffix) => {\n    const filePath = path.resolve(pluginsDirectory, name + suffix);\n    try {\n      const stats = await stat(filePath);\n      if (stats.isFile()) {\n        paths.push(filePath);\n      }\n    } catch {\n      return;\n    }\n  });\n  await Promise.all(promises);\n  if (paths.length === 0) {\n    throw new Error(`Плагин \"${name}\" не найден`);\n  }\n  const file = paths[0];\n  if (paths.length > 1) {\n    console.warn(`Неоднозначный файл плагина: ${name}. Используется файл: ${file}`);\n  }\n  if (file.endsWith(\".cjs\")) {\n    return load.cjs(file);\n  } else {\n    return await load.esm(file);\n  }\n}\nawait init();\nexport {\n  EventsPipe as E,\n  config as c\n};\n"],"names":[],"mappings":";;;;;;;;;;AAUA,SAAS,MAAM,CAAC,MAAM,EAAE,QAAQ,EAAE;AAClC,EAAE,IAAI,MAAM,GAAG,EAAE,CAAC;AAClB,EAAE,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,MAAM,KAAK;AAChC,IAAI,MAAM,IAAI,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;AACtC,IAAI,MAAM,UAAU,GAAG,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;AAC3C,IAAI,MAAM,QAAQ,GAAG,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;AACzC,IAAI,IAAI,UAAU,IAAI,CAAC,IAAI,QAAQ,IAAI,CAAC,EAAE;AAC1C,MAAM,MAAM,OAAO,GAAG,MAAM,CAAC,KAAK,CAAC,UAAU,GAAG,CAAC,EAAE,QAAQ,CAAC,CAAC;AAC7D,MAAM,MAAM,MAAM,GAAG,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC,CAAC;AACjE,MAAM,MAAM,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,EAAE,UAAU,CAAC,GAAG,MAAM,CAAC,KAAK,CAAC,QAAQ,GAAG,CAAC,CAAC,CAAC;AACxE,MAAM,QAAQ,CAAC,MAAM,CAAC,CAAC;AACvB,KAAK;AACL,GAAG,CAAC,CAAC;AACL,CAAC;AACD,SAAS,KAAK,CAAC,MAAM,EAAE,IAAI,EAAE;AAC7B,EAAE,MAAM,CAAC,KAAK,CAAC,GAAG,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC;AAC/D,CAAC;AACD,MAAM,UAAU,GAAG,GAAG,CAAC;AACvB,EAAE,eAAe,EAAE,MAAM;AACzB,EAAE,gBAAgB,EAAE,MAAM;AAC1B,EAAE,eAAe,EAAE,MAAM;AACzB,EAAE,SAAS,EAAE,OAAO;AACpB,CAAC,CAAC,CAAC;AACH,MAAM,UAAU,GAAG,UAAU,CAAC,eAAe,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,YAAY,CAAC,CAAC;AAC5F,MAAM,gBAAgB,GAAG,UAAU,CAAC,gBAAgB,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,SAAS,CAAC,CAAC;AAChG,UAAU,CAAC,eAAe,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE,EAAE,QAAQ,CAAC,CAAC;AACrE,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,MAAM,QAAQ,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,KAAK,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,MAAM;AAC9H,EAAE,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,uCAAuC,EAAE,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;AACvF,EAAE,OAAO,EAAE,OAAO,EAAE,EAAE,EAAE,CAAC;AACzB,CAAC,CAAC,CAAC;AACE,MAAC,MAAM,GAAG;AACf,EAAE,KAAK,EAAE,kBAAkB;AAC3B,EAAE,KAAK,EAAE,yCAAyC;AAClD,EAAE,IAAI,EAAE,mBAAmB;AAC3B,EAAE,IAAI,EAAE,GAAG;AACX,EAAE,OAAO,EAAE,EAAE;AACb,EAAE,2BAA2B,EAAE,KAAK;AACpC,EAAE,UAAU,EAAE,EAAE;AAChB,EAAE,KAAK,EAAE,EAAE;AACX,EAAE,GAAG,YAAY;AACjB,EAAE;AACF,OAAO,CAAC,GAAG,CAAC,IAAI,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AAClC,MAAC,UAAU,GAAG,IAAI,MAAM,eAAe,SAAS,YAAY,CAAC;AAClE,EAAE,WAAW,GAAG;AAChB,IAAI,KAAK,EAAE,CAAC;AACZ,IAAI,IAAI,UAAU,CAAC,SAAS,CAAC,EAAE;AAC/B,MAAM,MAAM,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,KAAK;AACjD,QAAQ,KAAK,CAAC,IAAI,CAAC,KAAK,EAAE,GAAG,IAAI,CAAC,CAAC;AACnC,OAAO,CAAC,CAAC;AACT,KAAK;AACL,GAAG;AACH,EAAE,IAAI,CAAC,KAAK,EAAE,GAAG,UAAU,EAAE;AAC7B,IAAI,IAAI,UAAU,CAAC,SAAS,CAAC,EAAE;AAC/B,MAAM,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,EAAE,KAAK,EAAE,MAAM,CAAC,KAAK,CAAC,EAAE,IAAI,EAAE,UAAU,EAAE,CAAC,CAAC;AACxE,KAAK;AACL,IAAI,OAAO,KAAK,CAAC,IAAI,CAAC,KAAK,EAAE,GAAG,UAAU,CAAC,CAAC;AAC5C,GAAG;AACH,CAAC,GAAG;AACJ,eAAe,IAAI,GAAG;AAItB,EAAE,MAAM,GAAG,GAAG,MAAM,MAAM,CAAC,MAAM,CAAC,SAAS;AAC3C,IAAI,KAAK;AACT,IAAI;AACJ,MAAM,GAAG,EAAE,OAAO;AAClB,MAAM,GAAG,EAAE,IAAI;AACf,MAAM,OAAO,EAAE,CAAC,QAAQ,CAAC;AACzB,MAAM,GAAG,EAAE,IAAI;AACf,MAAM,CAAC,EAAE,0FAA0F;AACnG,MAAM,CAAC,EAAE,0FAA0F;AACnG,KAAK;AACL,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE,UAAU,EAAE,OAAO,EAAE;AAC1C,IAAI,IAAI;AACR,IAAI,CAAC,QAAQ,CAAC;AACd,GAAG,CAAC;AACJ,EAAE,IAAI,CAAC,MAAM,CAAC,UAAU,EAAE;AAC1B,IAAI,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,CAAC,+BAA+B,CAAC,CAAC,CAAC;AAClE,IAAI,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AACpB,GAAG;AACH,EAAE,MAAM,CAAC,EAAE,EAAE,SAAS,CAAC,GAAG,MAAM,CAAC,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;AACvD,EAAE,MAAM,MAAM,GAAG,MAAM,MAAM,CAAC,MAAM,CAAC,MAAM;AAC3C,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE;AACtC,IAAI,GAAG;AACP,IAAI,MAAM,CAAC,IAAI,CAAC,SAAS,EAAE,QAAQ,CAAC;AACpC,IAAI,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC;AACnB,GAAG,CAAC;AACJ,EAAE,IAAI,CAAC,MAAM,EAAE;AACf,IAAI,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,CAAC,gCAAgC,CAAC,CAAC,CAAC;AACnE,IAAI,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AACpB,GAAG;AACH,EAAE,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,WAAW,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;AAC3D,EAAE,MAAM,sBAAsB,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,CAAC,IAAI,CAAC,CAAC,KAAK,KAAK,KAAK,CAAC,WAAW,EAAE,CAAC,CAAC,KAAK,CAAC,MAAM,KAAK,CAAC,CAAC;AACtH,EAAE,IAAI,CAAC,sBAAsB,EAAE;AAC/B,IAAI,OAAO,CAAC,GAAG;AACf,MAAM,KAAK,CAAC,SAAS,CAAC,CAAC,8BAA8B,EAAE,gBAAgB,CAAC,qBAAqB,CAAC,CAAC;AAC/F,KAAK,CAAC;AACN,IAAI,OAAO;AACX,GAAG;AACH,EAAE,KAAK,MAAM,CAAC,UAAU,EAAE,YAAY,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,OAAO,IAAI,EAAE,CAAC,EAAE;AACjF,IAAI,IAAI,CAAC,YAAY,IAAI,OAAO,YAAY,KAAK,QAAQ,IAAI,SAAS,IAAI,YAAY,IAAI,YAAY,CAAC,OAAO,KAAK,KAAK,EAAE;AAC1H,MAAM,OAAO,CAAC,GAAG;AACjB,QAAQ,KAAK,CAAC,YAAY;AAC1B,UAAU,CAAC,OAAO,EAAE,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,mDAAmD,CAAC;AAC/F,SAAS;AACT,OAAO,CAAC;AACR,KAAK,MAAM;AACX,MAAM,IAAI,SAAS,CAAC;AACpB,MAAM,IAAI,MAAM,CAAC;AACjB,MAAM,IAAI;AACV,QAAQ,MAAM,GAAG,MAAM,UAAU,CAAC,UAAU,CAAC,CAAC;AAC9C,OAAO,CAAC,OAAO,KAAK,EAAE;AACtB,QAAQ,SAAS,GAAG,KAAK,CAAC;AAC1B,OAAO;AACP,MAAM,IAAI,CAAC,MAAM,EAAE;AACnB,QAAQ,OAAO,CAAC,GAAG;AACnB,UAAU,KAAK,CAAC,SAAS,CAAC,CAAC,4BAA4B,EAAE,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;AACnF,UAAU,SAAS;AACnB,SAAS,CAAC;AACV,QAAQ,SAAS;AACjB,OAAO;AACP,MAAM,MAAM,aAAa,GAAG,MAAM,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC;AACvD,MAAM,MAAM,MAAM,CAAC,IAAI,CAAC,aAAa,EAAE,UAAU,CAAC,CAAC;AACnD,MAAM,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,WAAW,CAAC,CAAC,OAAO,EAAE,MAAM,CAAC,IAAI,IAAI,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;AACrF,KAAK;AACL,GAAG;AACH,CAAC;AACD,MAAM,IAAI,GAAG;AACb,EAAE,GAAG,EAAE,aAAa,CAAC,gBAAgB,CAAC;AACtC,EAAE,GAAG,EAAE,CAAC,IAAI,KAAK;AACjB,IAAI,IAAI,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;AAC5B,MAAM,IAAI,GAAG,aAAa,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,CAAC;AAC5C,KAAK;AACL,IAAI,OAAO;AACX;AACA,MAAM,IAAI;AACV,KAAK,CAAC;AACN,GAAG;AACH,CAAC,CAAC;AACF,MAAM,QAAQ,GAAG;AACjB,EAAE,EAAE;AACJ,EAAE,KAAK;AACP,EAAE,MAAM;AACR,EAAE,MAAM;AACR,EAAE,WAAW;AACb,EAAE,YAAY;AACd,EAAE,YAAY;AACd,EAAE,YAAY;AACd,EAAE,aAAa;AACf,EAAE,aAAa;AACf,CAAC,CAAC;AACF,eAAe,UAAU,CAAC,IAAI,EAAE;AAChC,EAAE,MAAM,KAAK,GAAG,EAAE,CAAC;AACnB,EAAE,MAAM,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,OAAO,MAAM,KAAK;AAClD,IAAI,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,gBAAgB,EAAE,IAAI,GAAG,MAAM,CAAC,CAAC;AACnE,IAAI,IAAI;AACR,MAAM,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,QAAQ,CAAC,CAAC;AACzC,MAAM,IAAI,KAAK,CAAC,MAAM,EAAE,EAAE;AAC1B,QAAQ,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;AAC7B,OAAO;AACP,KAAK,CAAC,MAAM;AACZ,MAAM,OAAO;AACb,KAAK;AACL,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;AAC9B,EAAE,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE;AAC1B,IAAI,MAAM,IAAI,KAAK,CAAC,CAAC,QAAQ,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;AAClD,GAAG;AACH,EAAE,MAAM,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;AACxB,EAAE,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;AACxB,IAAI,OAAO,CAAC,IAAI,CAAC,CAAC,4BAA4B,EAAE,IAAI,CAAC,qBAAqB,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC;AACpF,GAAG;AACH,EAAE,IAAI,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE;AAC7B,IAAI,OAAO,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AAC1B,GAAG,MAAM;AACT,IAAI,OAAO,MAAM,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AAChC,GAAG;AACH,CAAC;AACD,MAAM,IAAI,EAAE;;;;"}