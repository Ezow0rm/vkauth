{"version":3,"file":"proxy-44d5cf04.js","sources":["../../../.svelte-kit/adapter-node/chunks/proxy.js"],"sourcesContent":["import ipRegex from \"ip-regex\";\nimport fetch from \"node-fetch\";\nimport path from \"node:path\";\nimport { HttpsProxyAgent } from \"https-proxy-agent\";\nimport { SocksProxyAgent } from \"socks-proxy-agent\";\nimport { readFile } from \"node:fs/promises\";\nimport { c as config } from \"./system.js\";\nimport chalk from \"chalk\";\nconst regex = ipRegex();\nconst defaults = {\n  checkUrl: \"https://api.vk.com\",\n  checkTimeout: 3e3,\n  filename: \"proxy.txt\",\n  reloadInterval: 6e4\n};\nconst proxyConfig = { ...defaults, ...config.proxy };\nproxyConfig.checkTimeout = Math.max(parseInt(proxyConfig.checkTimeout), 500) || 500;\nproxyConfig.reloadInterval = Math.max(parseInt(proxyConfig.reloadInterval), 1e4) || 1e4;\nproxyConfig.filename ||= defaults.filename;\nproxyConfig.checkUrl ||= defaults.checkUrl;\ntry {\n  new URL(proxyConfig.checkUrl);\n} catch {\n  console.log(\n    chalk.redBright(\n      `Недопустимый URL проверки прокси: ${proxyConfig.checkUrl}. Для проверки будет использоваться: ${defaults.checkUrl}`\n    )\n  );\n  proxyConfig.checkUrl = defaults.checkUrl;\n}\nconst proxyFile = path.resolve(process.cwd(), proxyConfig.filename);\nconst cache = /* @__PURE__ */ new Map();\nclass Proxy {\n  static normalize(line, defaultProto = \"socks\") {\n    if (line.includes(\"://\")) {\n      const match = /^socks(4|5):\\/\\/(.*)/.exec(line);\n      if (match)\n        return `socks://${match[2]}`;\n      return line;\n    }\n    if (line.includes(\"@\")) {\n      const [part1, part2] = line.split(\"@\");\n      if (regex.test(part2)) {\n        return `${defaultProto}://${line}`;\n      }\n      return `${defaultProto}://${part2}@${part1}`;\n    }\n    const parts = line.split(\":\");\n    if (isPort(parts[1])) {\n      const [hostname, port, username, password] = parts;\n      const url = new URL(`${defaultProto}://${hostname}:${port}`);\n      if (username)\n        url.username = username;\n      if (password)\n        url.password = password;\n      return url.toString();\n    }\n    if (isPort(parts[3])) {\n      const [username, password, hostname, port] = parts;\n      const url = new URL(`${defaultProto}://${hostname}:${port}`);\n      url.username = username;\n      url.password = password;\n      return url.toString();\n    }\n    throw new Error(`Invalid proxy format: ${line}`);\n  }\n  static getAgent(forUrl) {\n    const url = new URL(forUrl);\n    if (url.protocol.startsWith(\"socks\")) {\n      return new SocksProxyAgent(forUrl);\n    }\n    if (url.protocol.startsWith(\"http\")) {\n      return new HttpsProxyAgent(forUrl);\n    }\n    throw new Error(`Unsupported proxy protocol: \"${url.protocol}\"`);\n  }\n  static async check(agent, {\n    timeout = proxyConfig.checkTimeout,\n    url = proxyConfig.checkUrl,\n    signal\n  } = {}) {\n    try {\n      if (!signal) {\n        const abortController = new AbortController();\n        setTimeout(() => abortController.abort(), timeout);\n        signal = abortController.signal;\n      }\n      await fetch(url, { agent, signal });\n      return true;\n    } catch {\n      return false;\n    }\n  }\n  _valid = false;\n  _url;\n  _agent;\n  _line;\n  get line() {\n    return this._line;\n  }\n  get valid() {\n    return this._valid;\n  }\n  get url() {\n    return this._url;\n  }\n  get agent() {\n    return this._agent;\n  }\n  constructor(line, url = Proxy.normalize(line)) {\n    const agent = Proxy.getAgent(url);\n    this._line = line;\n    this._url = url;\n    this._agent = agent;\n  }\n  async check(options = {}) {\n    this._valid = await Proxy.check(this.agent, options);\n    return this.valid;\n  }\n}\nfunction isPort(part) {\n  const value = parseInt(part);\n  return value > 0 && value <= 65535 && value.toString() === part;\n}\nasync function resolve(line) {\n  const cached = cache.get(line);\n  if (cached) {\n    return cached;\n  }\n  const variants = /* @__PURE__ */ new Set();\n  for (const protocol of [\"https\", \"socks\", \"http\"]) {\n    variants.add(Proxy.normalize(line, protocol));\n  }\n  const abortController = new AbortController();\n  const { signal } = abortController;\n  let proxy;\n  await Promise.all(\n    [...variants].map(async (url) => {\n      const instance = new Proxy(line, url);\n      await instance.check({ signal });\n      if (instance.valid) {\n        abortController.abort();\n        proxy = instance;\n      }\n      if (!proxy || !proxy.valid) {\n        proxy = instance;\n      }\n    })\n  );\n  setTimeout(() => abortController.abort(), proxyConfig.checkTimeout);\n  if (!proxy) {\n    proxy = new Proxy(line);\n    await proxy.check();\n  }\n  console.log(\n    chalk.blueBright(`Проверено прокси ${proxy.line}. Результат:`),\n    proxy.valid ? chalk.greenBright(`РАБОЧЕЕ`) : chalk.redBright(\"НЕРАБОЧЕЕ\")\n  );\n  cache.set(line, proxy);\n  cache.set(proxy.url, proxy);\n  return proxy;\n}\nasync function getList() {\n  const lines = (await readFile(proxyFile, \"utf-8\").catch(() => \"\")).split(\"\\n\").map((line) => line.trim()).filter(Boolean);\n  const results = await Promise.allSettled(lines.map(resolve));\n  return results.flatMap((r) => r.status === \"fulfilled\" ? [r.value] : []);\n}\nconst proxies = [];\nfunction update() {\n  getList().then((list) => proxies.splice(0, proxies.length, ...list));\n}\nlet initialized = false;\nfunction init() {\n  if (initialized) {\n    return;\n  }\n  setInterval(update, proxyConfig.reloadInterval);\n  update();\n  initialized = true;\n}\nfunction getRandomAgent() {\n  return proxies[Math.floor(Math.random() * proxies.length)];\n}\nexport {\n  getRandomAgent as g,\n  init as i\n};\n"],"names":[],"mappings":"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"}